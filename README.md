# Story Book Server (FastAPI 백엔드)

Story Book Server는 여행자와 지역 가이드를 연결하는 스토리 기반 매칭 플랫폼의 백엔드 서버입니다. FastAPI로 구현되었으며, 가이드가 자신의 여행 이야기를 스토리 형태로 공유하고, 여행자는 마음에 드는 스토리의 가이드에게 매칭을 요청하여 함께 여행을 계획할 수 있습니다. 소셜 로그인, 실시간 채팅 등 다양한 기능을 통해 여행자와 가이드 간 원활한 소통을 지원합니다.

---

## 목차
- [프로젝트 개요 및 목적](#프로젝트-개요-및-목적)
- [주요 기능](#주요-기능)
- [기술 스택](#기술-스택)
- [프로젝트 구조](#프로젝트-구조)
- [설치 및 실행 방법](#설치-및-실행-방법)
- [주요 API 엔드포인트](#주요-api-엔드포인트)
- [시스템 아키텍처 다이어그램](#시스템-아키텍처-다이어그램)
- [데이터 모델 (ERD) 요약](#데이터-모델-erd-요약)
---

## 프로젝트 개요 및 목적

Story Book 플랫폼은 여행자와 가이드 간의 스토리 공유를 통한 매칭을 목표로 합니다. 가이드들은 자신만의 여행 경험이나 투어 계획을 **스토리(여행 이야기)**로 등록하고, 여행자들은 다양한 스토리를 탐색하며 흥미로운 활동이나 투어를 찾을 수 있습니다. 여행자가 마음에 드는 스토리를 발견하면 해당 가이드에게 매칭을 요청하여 구체적인 여행 일정을 협의할 수 있습니다. 이렇듯 스토리를 매개로 여행자에게는 특별한 경험을, 가이드에게는 새로운 고객과의 연결 기회를 제공하는 것이 이 프로젝트의 목적입니다.

---

## 주요 기능

-   **카카오 소셜 로그인**: Kakao OAuth 2.0를 통한 간편 로그인 기능을 제공합니다. 사용자가 Kakao 계정으로 로그인하면 백엔드에서 Kakao 액세스 토큰 검증 후 자체 JWT를 발급하여 인증 세션을 관리합니다 (access/refresh 토큰). 별도 회원가입 없이 Kakao 프로필 정보를 이용하여 **사용자(User)**가 생성됩니다.
-   **가이드 프로필 등록**: 일반 사용자는 가이드 신청을 통해 가이드 프로필을 생성할 수 있습니다. 신청 시 Guide 테이블에 프로필(자기소개, 평균 평점, 리뷰 수 등)이 생성되며 관리자가 승인하면 활동 가능한 승인 가이드가 됩니다. 가이드 프로필에는 한 명의 사용자 계정이 1:1로 연결됩니다.
-   **스토리 업로드 및 조회**: 가이드만 자신만의 여행 콘텐츠를 스토리로 게시할 수 있습니다 (제목, 내용, 카테고리 등). 사진, 동영상 등 미디어 업로드를 지원하며 업로드 시 자동으로 썸네일이 생성됩니다. 스토리는 지역(도시/지역 정보)과 연결되어 저장되므로, 여행자는 지역별로 스토리를 필터링하거나 인기 스토리를 탐색할 수 있습니다. 여행자는 스토리 상세를 열람하여 내용, 첨부 미디어, 작성 가이드 프로필, 등록일 등을 확인할 수 있습니다.
-   **좋아요, 댓글, 북마크**: 여행자는 마음에 드는 스토리에 좋아요를 눌러 가이드를 응원하거나 관심 표시를 할 수 있고, 댓글을 통해 궁금한 점을 물어보거나 의견을 공유할 수 있습니다. 또한 북마크 기능으로 나중에 다시 보고 싶은 스토리를 저장해 둘 수 있으며, 자신의 좋아요/북마크한 스토리 목록을 따로 조회할 수 있습니다.
-   **가이드 매칭 기능**: 여행자는 특정 스토리의 가이드에게 매칭 요청을 보낼 수 있습니다. 매칭 요청 시 원하는 날짜/시간과 간단한 메시지를 함께 전송할 수 있으며, 가이드는 받은 요청 목록을 확인하고 수락(accepted) 또는 **거절(rejected)**할 수 있습니다. 가이드가 요청을 수락하면 해당 스토리에는 가이드가 매칭된 것으로 표시되고, 매칭 상태가 업데이트됩니다. (요청 상태는 대기중→수락/거절/완료 등으로 관리)
-   **실시간 1:1 채팅**: 매칭이 성사되면 실시간 채팅 기능을 통해 여행자와 가이드가 앱 내에서 직접 대화할 수 있습니다. 백엔드는 WebSocket을 이용한 실시간 통신을 지원하며, 채팅 서버에 사용자들이 소켓으로 연결하여 1:1 메시지를 주고받습니다. 채팅방은 매칭 요청 단위로 개설되며, 채팅 내용은 데이터베이스에 채팅 메시지로 저장되고, 최근 메시지 정보가 채팅방에 업데이트됩니다. WebSocket 연결이 어려운 경우를 대비해 REST API로 채팅 메시지 조회/전송도 가능하도록 구현되어 있습니다.
-   **지역 기반 검색 및 지도**: 등록된 지역(Region) 정보와 해당 지역의 스토리 개수를 제공하며, 인기 카테고리 등의 정보를 함께 제공합니다. 이는 지도 화면에서 특정 지역을 선택하면 그 지역의 스토리 수, 인기 키워드 등을 보여주는 기능에 활용됩니다. (예: `/regions/map` 엔드포인트는 각 지역별 위도/경도와 인기 스토리 카테고리를 반환)
-   **콘텐츠 신고 및 관리**: 부적절한 콘텐츠의 경우 사용자가 스토리 신고 기능을 통해 사유를 제출할 수 있습니다. 신고된 콘텐츠는 관리자 검토를 거쳐 조치되며, 가이드의 스토리 게시물 관리에 반영됩니다. (관리자용 기능으로, 백엔드에 신고 저장 로직이 있으며 추후 관리자 페이지에서 처리 예정)
-   **기타**: 그 밖에 JWT 인증을 통한 API 보안, CORS 설정으로 프론트엔드 도메인 허용, 개발/프로덕션 환경 분리를 위한 설정 파일 관리 등이 포함됩니다.

---

## 기술 스택

-   **언어 및 프레임워크**: Python 3.x, FastAPI (Modern Async Web Framework)
-   **인증 및 보안**: Kakao OAuth 2.0 API, JWT (JSON Web Tokens, `python-jose` 라이브러리)
-   **데이터베이스**: MySQL (8.x) 및 SQLAlchemy ORM (v2)를 이용한 데이터 모델링. MySQL Connector (`mysql-connector-python`) 사용
-   **실시간 통신**: WebSocket (FastAPI의 WebSocket 지원 활용)으로 구현된 실시간 채팅 기능.
-   **캐시 및 기타**: Redis (채팅 세션 관리 및 향후 확장 용도), Python `httpx` (카카오 API 통신), Python `dotenv` (환경변수 관리).
-   **미디어 처리**: OpenCV (`cv2`)와 Pillow(`PIL`) 라이브러리를 사용하여 업로드된 이미지/동영상으로부터 썸네일 생성 기능 구현. (예: 업로드된 동영상의 첫 프레임을 추출하여 JPEG 이미지 생성)
-   **구조 및 형상관리**: Pydantic (v2) 기반의 모델(BaseModel)로 요청/응답 데이터 검증, Uvicorn ASGI 서버를 이용한 애플리케이션 구동.

(버전 정보 등 자세한 사항은 `requirements.txt` 참고)

---

## 프로젝트 구조

```bash
stroy_book_server-main/    # 프로젝트 루트 디렉토리
├── app/
│   ├── api/              # FastAPI 라우터 및 엔드포인트 정의
│   │   ├── endpoints/    # 개별 기능별 API 엔드포인트 모듈
│   │   │   ├── auth.py         # 인증 (카카오 로그인, 토큰 갱신)
│   │   │   ├── users.py        # 사용자 (프로필 조회/수정, 내 스토리, 좋아요 목록 등)
│   │   │   ├── stories.py      # 스토리 (목록, 생성, 상세, 댓글, 좋아요, 북마크, 신고 등)
│   │   │   ├── matching.py     # 가이드 신청 및 매칭 (요청 생성/조회/승인, 채팅방/메시지)
│   │   │   ├── websocket.py    # 실시간 채팅 WebSocket 엔드포인트
│   │   │   └── regions.py      # 지역 정보 (목록, 지도 데이터, 상세)
│   │   └── api.py         # 주요 라우터들을 하나로 모아 /api/v1 경로에 포함
│   ├── core/             # 핵심 설정 및 기능 모듈
│   │   ├── config.py      # 환경변수 및 설정 (Pydantic BaseSettings 이용)
│   │   ├── database.py    # 데이터베이스 연결 설정 (SQLAlchemy Engine, Session)
│   │   └── security.py    # 보안/인증 관련 기능 (JWT 토큰 생성/검증, 비밀번호 해싱 등)
│   ├── models/           # 데이터베이스 ORM 모델 정의(SQLAlchemy ORM)
│   │   ├── user.py         # User 모델 (사용자, RefreshToken 등)
│   │   ├── guide.py        # Guide 모델 (가이드 프로필)
│   │   ├── story.py        # Story 모델 (스토리 및 StoryLike, StoryComment 등)
│   │   ├── matching.py     # MatchingRequest 및 ChatMessage 모델 (매칭 요청, 채팅 메시지)
│   │   ├── chat.py         # ChatRoom 모델 (채팅방)
│   │   ├── bookmark.py     # StoryBookmark 모델 (스토리 북마크 연결)
│   │   └── region.py       # Region 모델 (지역 정보)
│   ├── schemas/          # Pydantic 스키마 정의 (요청 검증 및 응답 직렬화)
│   │   ├── user.py         # User, KakaoLoginRequest, Token 등 사용자 관련 스키마
│   │   ├── story.py        # Story 생성/응답, Comment 응답 등 스키마
│   │   ├── matching.py     # GuideResponse, MatchingRequest/Response 등 매칭 관련 스키마
│   │   └── region.py       # Region 응답 스키마 (RegionResponse 등)
│   ├── services/         # 서비스 계층 모듈 (외부 API 연동 및 비즈니스 로직)
│   │   ├── kakao_service.py      # Kakao API 연동 서비스 (액세스 토큰으로 사용자 정보 획득 등)
│   │   ├── matching_service.py   # 매칭 로직 서비스 (매칭 요청 생성, 상태변경, 채팅방 생성 관리)
│   │   └── thumbnail_service.py  # 썸네일 생성 서비스 (OpenCV로 이미지/동영상 썸네일 생성)
│   └── websocket/        # 웹소켓 기능 관련 모듈
│       ├── chat_websocket.py    # 채팅 WebSocket 연결 관리 (ConnectionManager 등 구현)
│       └── __init__.py
├── uploads/             # 업로드된 파일 및 생성된 썸네일 저장 디렉토리
│   ├── stories/           # 업로드된 스토리 원본 미디어 파일 (이미지/영상 등)
│   └── thumbnails/        # 생성된 썸네일 이미지 파일
├── scripts/             # 보조 스크립트 (예: 샘플 데이터 DB삽입 등)
│   ├── init_regions.py    # 기본 지역 데이터 DB 초기화 스크립트
│   └── add_sample_videos.py # 샘플 비디오 업로드/썸네일 생성 테스트 스크립트
├── .env                # 환경변수 설정 파일 (로컬 개발용)
├── PRODUCTION.md       # 프로덕션 환경 설정 가이드 (DB 설정, 환경변수, 카카오 앱 설정 등)
├── requirements.txt    # 프로젝트 의존 패키지 목록
└── main.py             # 애플리케이션 진입점 - FastAPI 앱 생성 및 라우터/미들웨어 설정
